# Claude AI Configuration & Usage Guidelines

**Project**: Math Education Multi-Agent System  
**Last Updated**: 2025-10-15  
**Claude Version**: Sonnet 4.5 (claude-sonnet-4-5-20250929)

---

## üîë API Key Configuration

### Claude Max x20 Subscription

**IMPORTANT**: This project is configured to use **Claude Max x20** subscription API keys.

The user maintains an active Claude Max x20 subscription, which provides:
- **Higher rate limits** than standard API tier
- **Priority access** to latest models
- **Cost-effective** for heavy usage
- **20x conversation capacity** per month

### API Key Setup

#### Method 1: Environment Variables (Recommended)

Create a `.env` file in the project root:

```bash
# .env file
ANTHROPIC_API_KEY=sk-ant-api03-xxxxx  # Your Claude Max x20 API key
```

**Security Best Practices:**
- ‚úÖ `.env` is already in `.gitignore` (never commit API keys)
- ‚úÖ Use environment variables for all sensitive data
- ‚úÖ Rotate keys periodically for security

#### Method 2: Claude Max x20 Web Interface

For interactive work, you can use the Claude web interface at https://claude.ai with your Max x20 subscription.

**Benefits:**
- No API key needed
- Web-based conversation interface
- Access to all subscription features
- Extended conversation history

---

## üöÄ Model Configuration

### Primary Model: Claude Sonnet 4.5

**Always use the specific version identifier, not aliases:**

```python
# ‚úÖ CORRECT: Specific version (production-ready)
model = "claude-sonnet-4-5-20250929"

# ‚ùå WRONG: Alias (unstable, can change)
model = "sonnet"
```

### Model Selection Guide

Based on `docs/CLAUDE-COMPLETE-REFERENCE.md`:

```python
MODEL_USAGE = {
    # Default for all agents
    "standard": "claude-sonnet-4-5-20250929",
    
    # For extremely complex tasks only
    "max_intelligence": "claude-opus-4-1-20250805",
    
    # For simple, cost-sensitive tasks
    "lightweight": "claude-3-5-haiku-20241022",
}
```

**Current Agent Configuration:**
- All 9 agents use Claude Sonnet 4.5
- This is optimal for our use case (complex reasoning + coding)

---

## üß† Extended Thinking Feature

### When to Enable

Extended Thinking provides **30-50% quality improvement** for:
- ‚úÖ Complex task orchestration (meta-orchestrator)
- ‚úÖ Root cause analysis (socratic-mediator)
- ‚úÖ Code improvement generation (self-improver)
- ‚úÖ Deep mathematical research (research-agent)
- ‚úÖ Dependency graph construction (dependency-mapper)

### Configuration

```python
# Example: Using Extended Thinking with Claude Max x20 API key
from anthropic import Anthropic
import os

client = Anthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))

response = client.messages.create(
    model="claude-sonnet-4-5-20250929",
    max_tokens=16_000,
    
    # Enable Extended Thinking
    thinking={
        "type": "enabled",
        "budget_tokens": 10_000  # Adjust based on task complexity
    },
    
    messages=[
        {"role": "user", "content": "Your complex task here..."}
    ]
)

# Access thinking process
for block in response.content:
    if block.type == "thinking":
        print(f"üß† Reasoning: {block.thinking}")
    elif block.type == "text":
        print(f"üìù Result: {block.text}")
```

### Budget Token Guidelines

```python
THINKING_BUDGET = {
    "simple_tasks": 1_000,       # Quick reasoning
    "standard_tasks": 5_000,     # Most agent operations
    "complex_tasks": 10_000,     # Meta-orchestrator, root cause analysis
    "very_complex": 32_000,      # Extremely complex proofs or analysis
}
```

**Note**: Claude Max x20 subscription includes generous token limits, so using Extended Thinking is cost-effective.

---

## üíæ Prompt Caching (Cost Optimization)

### Why Use It

With Claude Max x20 subscription, Prompt Caching provides:
- **90% cost reduction** on repeated calls
- **Faster response times** (cache hits are instant)
- **Efficient token usage** (counts toward your monthly limit)

### Cache Strategy

```python
# Example: Caching static content
response = client.messages.create(
    model="claude-sonnet-4-5-20250929",
    max_tokens=4096,
    
    # Cache the system prompt (1 hour tier)
    system=[
        {
            "type": "text",
            "text": """Your long system prompt here...
            
[2000+ lines of static instructions, taxonomy, examples]
""",
            "cache_control": {"type": "ephemeral"}  # Cache this!
        }
    ],
    
    messages=[...]
)

# Monitor cache performance
usage = response.usage
if hasattr(usage, 'cache_read_input_tokens'):
    cache_savings = usage.cache_read_input_tokens * 0.9 * 0.000003
    print(f"üí∞ Cost saved: ${cache_savings:.4f}")
```

### What to Cache

```python
CACHE_TARGETS = {
    "system_prompts": "1h",           # Rarely change
    "tool_definitions": "1h",         # Static
    "taxonomy_examples": "5m",        # Frequently accessed
    "research_guidelines": "1h",      # Stable reference
    "validation_rules": "1h",         # Quality standards
}
```

**With Claude Max x20**: Cache liberally to maximize your subscription value.

---

## üìö Context Management

### 1M Token Context (Beta)

Claude Max x20 subscription includes access to **1M token context window** (beta).

#### When to Use

- ‚úÖ Processing 57+ topology concepts at once (dependency-mapper)
- ‚úÖ Long multi-agent workflows (meta-orchestrator)
- ‚úÖ Complete project context analysis
- ‚úÖ Multiple research papers simultaneously

#### Configuration

```python
response = client.messages.create(
    model="claude-sonnet-4-5-20250929",
    max_tokens=64_000,
    
    # Enable 1M context (beta)
    extra_headers={
        "anthropic-beta": "context-1m-2025-08-07"
    },
    
    messages=[
        {"role": "user", "content": "Very long content here... [up to 1M tokens]"}
    ]
)
```

### Context Awareness

Claude Sonnet 4.5 automatically tracks token usage and prevents premature task abandonment.

**Your Claude Max x20 subscription benefits:**
- Higher monthly token limits
- Priority access to beta features
- Better performance on long-running tasks

---

## üåä Streaming Responses

### Enable for Better UX

```python
# Streaming with Extended Thinking
with client.messages.stream(
    model="claude-sonnet-4-5-20250929",
    max_tokens=16_000,
    thinking={"type": "enabled", "budget_tokens": 10_000},
    messages=[{"role": "user", "content": "Complex task..."}]
) as stream:
    for event in stream:
        if event.type == "content_block_delta":
            # Show reasoning + result incrementally
            print(event.delta.text or event.delta.thinking, end="", flush=True)
```

**Benefits with Max x20:**
- Real-time visibility into Claude's reasoning
- Better user experience
- No additional cost

---

## üîß Agent SDK Configuration

### Current Setup

```python
# main.py configuration
options = ClaudeAgentOptions(
    model="claude-sonnet-4-5-20250929",  # ‚Üê Specific version (updated)
    permission_mode="acceptEdits",
    setting_sources=["project"],
    
    allowed_tools=[
        'Task',  # Required for multi-agent delegation
        'Read', 'Write', 'Edit',
        'Grep', 'Glob',
        'TodoWrite',
        'mcp__sequential-thinking__sequentialthinking',
        'mcp__memory-keeper__context_save',
        'mcp__memory-keeper__context_get',
        'mcp__memory-keeper__context_search',
    ],
    
    agents={
        "meta-orchestrator": meta_orchestrator,
        "knowledge-builder": knowledge_builder,
        "quality-agent": quality_agent,
        "research-agent": research_agent,
        "example-generator": example_generator,
        "dependency-mapper": dependency_mapper,
        "socratic-planner": socratic_planner,
        "socratic-mediator": socratic_mediator_agent,
        "self-improver": self_improver_agent,
    },
    
    mcp_servers={}  # MCP servers configured in .mcp.json
)

# Initialize client with your Claude Max x20 API key
async with ClaudeSDKClient(options=options) as client:
    # Agent interactions...
```

---

## üìä Rate Limits (Claude Max x20)

### Claude Max x20 Subscription Limits

Your subscription provides enhanced limits:

```python
MAX_X20_LIMITS = {
    "requests_per_minute": 50,        # Default API tier
    "tokens_per_minute": 40_000,      # May be higher with Max subscription
    "tokens_per_day": 1_000_000,      # Generous daily limit
    
    # Max x20 benefits
    "priority_access": True,           # Skip queues during high demand
    "beta_features": True,             # Early access to new features
    "conversation_capacity": "20x",    # 20x normal capacity
}
```

### Monitoring Usage

```python
# Check rate limit headers in responses
headers = response.headers
print(f"Requests remaining: {headers.get('anthropic-ratelimit-requests-remaining')}")
print(f"Tokens remaining: {headers.get('anthropic-ratelimit-tokens-remaining')}")
print(f"Reset time: {headers.get('anthropic-ratelimit-requests-reset')}")
```

---

## üõ°Ô∏è Security Best Practices

### API Key Protection

```bash
# ‚úÖ ALWAYS use environment variables
export ANTHROPIC_API_KEY=sk-ant-api03-xxxxx

# ‚úÖ NEVER hardcode in source files
# ‚ùå BAD: api_key = "sk-ant-api03-xxxxx"
# ‚úÖ GOOD: api_key = os.getenv("ANTHROPIC_API_KEY")
```

### .gitignore Configuration

```bash
# Already configured in .gitignore
.env
.env.*
*.key
secrets/
```

### Rotate Keys Regularly

1. Generate new API key from Claude Max x20 settings
2. Update `.env` file
3. Test with a simple request
4. Deactivate old key

---

## üí∞ Cost Optimization with Claude Max x20

### Subscription Model

Claude Max x20 uses a **subscription model** (not pay-per-token), so:

‚úÖ **Optimize for Quality, Not Cost**
- Enable Extended Thinking liberally
- Use Prompt Caching for efficiency
- Don't worry about token counting (within limits)

‚úÖ **Maximize Subscription Value**
- Use 1M context when needed
- Enable streaming for all user-facing interactions
- Cache everything that's static

‚úÖ **Monitor Usage Patterns**
```python
# Track feature usage
FEATURE_USAGE = {
    "extended_thinking_calls": 0,
    "cache_hit_rate": 0.0,
    "1m_context_calls": 0,
    "avg_tokens_per_request": 0,
}
```

### Monthly Capacity Planning

```python
MAX_X20_MONTHLY_CAPACITY = {
    "total_conversations": "20x standard",  # ~10,000-20,000 exchanges
    "token_limit": "Very high",             # Rarely hit limit
    "priority_tier": True,                  # Fast responses
    
    # Best practices
    "use_extended_thinking": True,  # Quality > speed
    "use_prompt_caching": True,     # Efficiency
    "use_streaming": True,          # UX
}
```

---

## üîç Troubleshooting

### API Key Issues

```python
# Test API key validity
from anthropic import Anthropic

try:
    client = Anthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))
    response = client.messages.create(
        model="claude-sonnet-4-5-20250929",
        max_tokens=10,
        messages=[{"role": "user", "content": "test"}]
    )
    print("‚úÖ API key is valid and working")
except Exception as e:
    print(f"‚ùå API key error: {e}")
```

### Common Issues

1. **"Invalid API key"**
   - Check `.env` file exists and is loaded
   - Verify key starts with `sk-ant-api03-`
   - Ensure Claude Max x20 subscription is active

2. **Rate limit errors**
   - Max x20 has high limits, but not unlimited
   - Implement exponential backoff
   - Use prompt caching to reduce token usage

3. **Model not found**
   - Use specific version: `claude-sonnet-4-5-20250929`
   - Avoid aliases like `"sonnet"`

---

## üìñ Reference Documentation

### Official Docs
- Claude Models: https://docs.claude.com/en/docs/about-claude/models
- Extended Thinking: https://docs.claude.com/en/docs/build-with-claude/extended-thinking
- Prompt Caching: https://docs.claude.com/en/docs/build-with-claude/prompt-caching
- API Reference: https://docs.claude.com/en/api

### Project Docs
- `CLAUDE-FEATURES-ANALYSIS-REPORT.md`: Comprehensive feature analysis
- `docs/CLAUDE-COMPLETE-REFERENCE.md`: Complete technical specification
- `README.md`: Project overview
- `scalable.pdf`: Multi-agent best practices

---

## üö¶ Quick Start Checklist

Before starting work with this project:

- [ ] Verify Claude Max x20 subscription is active
- [ ] Create `.env` file with `ANTHROPIC_API_KEY`
- [ ] Test API key with simple request
- [ ] Review `CLAUDE-FEATURES-ANALYSIS-REPORT.md`
- [ ] Understand agent architecture (8 specialized agents)
- [ ] Configure MCP servers (see `.mcp.json`)
- [ ] Run tests: `pytest tests/`
- [ ] Enable Extended Thinking for complex agents
- [ ] Set up Prompt Caching for cost efficiency
- [ ] Monitor usage with performance_monitor.py

---

## üéØ Best Practices Summary

### Do's ‚úÖ

- ‚úÖ Use specific model version: `claude-sonnet-4-5-20250929`
- ‚úÖ Enable Extended Thinking for complex tasks
- ‚úÖ Implement Prompt Caching for static content
- ‚úÖ Use 1M context for large batches
- ‚úÖ Store API keys in environment variables
- ‚úÖ Monitor cache hit rates and token usage
- ‚úÖ Use streaming for user-facing interactions
- ‚úÖ Maximize Claude Max x20 subscription value

### Don'ts ‚ùå

- ‚ùå Don't use model aliases (`"sonnet"`)
- ‚ùå Don't hardcode API keys
- ‚ùå Don't skip Extended Thinking on complex tasks
- ‚ùå Don't ignore Prompt Caching opportunities
- ‚ùå Don't commit `.env` files
- ‚ùå Don't exceed rate limits unnecessarily
- ‚ùå Don't use wrong model for task complexity

---

## üìû Support

### Claude Max x20 Support
- Web: https://claude.ai/settings
- Email: support@anthropic.com
- Status: https://status.anthropic.com

### Project Issues
- See `CLAUDE-FEATURES-ANALYSIS-REPORT.md` for implementation guidance
- Check existing tests in `tests/` directory
- Review agent definitions in `agents/` directory

---

**Last Updated**: 2025-10-15  
**Maintained By**: Project team  
**Claude Version**: Sonnet 4.5 (claude-sonnet-4-5-20250929)  
**Subscription**: Claude Max x20 (Active)

---

## üîÑ Version History

### v1.0.0 (2025-10-15)
- Initial configuration documentation
- Claude Max x20 subscription guidelines
- Extended Thinking configuration
- Prompt Caching setup
- 1M context usage guide
- Security best practices

---

## üìö Related Documentation

### Implementation Standards (CRITICAL)

**‚ö†Ô∏è MANDATORY: Before ANY code changes, read:**

üìÑ **`CLAUDE-IMPLEMENTATION-STANDARDS.md`** - Non-negotiable implementation standards

This document defines MANDATORY requirements for ALL code:
- ‚úÖ Specific model version (claude-sonnet-4-5-20250929)
- ‚úÖ Extended Thinking configuration
- ‚úÖ Prompt Caching implementation  
- ‚úÖ 1M Context for meta-orchestrator
- ‚úÖ Streaming for user interactions

**No exceptions without documented approval.**

### Other Documentation

- `CLAUDE-FEATURES-ANALYSIS-REPORT.md` - Comprehensive feature analysis
- `docs/CLAUDE-COMPLETE-REFERENCE.md` - Complete technical specification
- `README.md` - Project overview

---

**END OF CONFIGURATION GUIDE**

