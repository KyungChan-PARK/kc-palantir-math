# 수학 교육 에이전트 시스템 - 시각적 아키텍처 가이드 v2.0

**버전**: 2.0.0
**날짜**: 2025년 10월 13일
**대상**: 비프로그래머, 시스템 이해관계자
**목적**: 프로그래밍 지식 없이 전체 시스템 구조 이해

---

## 🎯 시스템 개요

### 무엇을 하는 시스템인가?

이 시스템은 **수학 개념을 자동으로 정리하고 문서화**하는 AI 에이전트 시스템입니다.

**예시**: 사용자가 "피타고라스 정리를 정리해줘"라고 요청하면:
1. 관련 자료 조사 (research-agent)
2. 구조화된 마크다운 문서 생성 (knowledge-builder)
3. 품질 검증 (quality-agent)
4. 예제 생성 (example-generator)
5. 선수 지식 매핑 (dependency-mapper)

결과물은 Obsidian 볼트에 저장됩니다.

---

## 🏗️ 시스템 구조 (레이어별)

### 레이어 1: 사용자 인터페이스

```
┌──────────────────────────────────────────┐
│          사용자 (User)                    │
│                                          │
│  입력: "피타고라스 정리를 정리해줘"         │
└──────────────────────────────────────────┘
                 ↓
┌──────────────────────────────────────────┐
│     main.py (시스템 진입점)                │
│                                          │
│  • 사용자 입력 받기                       │
│  • trace_id 생성 (추적용 고유 번호)       │
│  • 로깅 시작                             │
│  • 메타-오케스트레이터에 전달             │
└──────────────────────────────────────────┘
```

**trace_id란?**
- 각 요청마다 고유한 번호 (예: `abc12345`)
- 로그 파일에서 특정 요청의 모든 이벤트 추적 가능
- 디버깅 시 매우 유용

---

### 레이어 2: 조정 레이어 (Orchestration)

```
┌──────────────────────────────────────────┐
│    메타-오케스트레이터                      │
│    (Meta-Orchestrator)                   │
│                                          │
│  역할: 총괄 지휘관                        │
│  • 요청 분석                             │
│  • 작업 분해                             │
│  • 에이전트 선택 및 병렬 실행             │
│  • 결과 통합                             │
└──────────────────────────────────────────┘
         ↓         ↓         ↓
```

**비유**: 오케스트라 지휘자
- 각 악기(에이전트)에게 언제 연주할지 지시
- 전체 하모니(결과물) 조율

---

### 레이어 3: 실행 레이어 (Specialized Agents)

```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ research    │  │ knowledge   │  │ quality     │
│ -agent      │  │ -builder    │  │ -agent      │
│             │  │             │  │             │
│ 자료 조사    │  │ 문서 작성    │  │ 품질 검증    │
└─────────────┘  └─────────────┘  └─────────────┘

┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ example     │  │ dependency  │  │ socratic    │
│ -generator  │  │ -mapper     │  │ -planner    │
│             │  │             │  │             │
│ 예제 생성    │  │ 선수지식     │  │ 요구사항     │
│             │  │ 매핑        │  │ 명확화      │
└─────────────┘  └─────────────┘  └─────────────┘
```

**특징**:
- 각 에이전트는 **전문가** (한 가지만 잘함)
- **병렬 실행** 가능 (동시에 여러 작업)
- **독립적** (서로 간섭하지 않음)

---

### 레이어 4: 인프라 레이어 (NEW in v2.0)

```
┌──────────────────────────────────────────┐
│       Infrastructure Layer (v2.0)        │
│                                          │
│  ┌────────────────┐  ┌────────────────┐  │
│  │ Error Handler  │  │ Structured     │  │
│  │ 에러 처리       │  │ Logger         │  │
│  │                │  │ 구조화 로깅     │  │
│  └────────────────┘  └────────────────┘  │
│                                          │
│  ┌────────────────┐  ┌────────────────┐  │
│  │ Performance    │  │ Context        │  │
│  │ Monitor        │  │ Manager        │  │
│  │ 성능 모니터링   │  │ 컨텍스트 관리   │  │
│  └────────────────┘  └────────────────┘  │
└──────────────────────────────────────────┘
```

이 레이어는 **보이지 않지만 중요한** 지원 시스템입니다.

---

## 🔄 전체 데이터 흐름도

### 정상 시나리오

```
사용자
  ↓
  "피타고라스 정리 정리해줘"
  ↓
main.py
  ↓
  [trace_id 생성: abc12345]
  [로깅 시작]
  ↓
Meta-Orchestrator
  ↓
  작업 분석: 조사 → 작성 → 검증
  ↓
병렬 실행
  ↓─────────┬─────────┬─────────┐
  ↓         ↓         ↓         ↓
research  knowledge example  dependency
-agent    -builder  -gen     -mapper
  ↓         ↓         ↓         ↓
  [자료]    [문서]    [예제]    [선수지식]
  ↓─────────┴─────────┴─────────┘
  ↓
quality-agent
  ↓
  ✅ 검증 통과
  ↓
Obsidian 파일 생성
  ↓
  /math-vault/Theorems/pythagorean-theorem.md
  ↓
사용자에게 결과 반환
```

**소요 시간 예시**:
- 순차 실행: 5분
- 병렬 실행: 1분 (⚡ 80% 단축)

---

### 에러 발생 시나리오

```
사용자 요청
  ↓
Agent 실행
  ↓
❌ 에러 발생 (예: 타임아웃)
  ↓
Error Handler 개입
  ↓
  [1차 재시도] 1초 대기
  ↓
❌ 여전히 에러
  ↓
  [2차 재시도] 2초 대기
  ↓
❌ 여전히 에러
  ↓
  [3차 재시도] 4초 대기
  ↓
✅ 성공!
  ↓
정상 흐름으로 복귀
```

**만약 3회 모두 실패하면?**
```
  ↓
⚠️ Human Escalation
  ↓
사람에게 알림
  ↓
수동 개입 필요
```

---

## 📊 4가지 인프라 모듈 설명

### 1. Error Handler (에러 처리기)

**비유**: 자동 수리공

```
┌─────────────────────────────────────┐
│     Error Handler                   │
│                                     │
│  문제 발생 → 자동 수리 시도         │
│  • 1차 시도: 1초 후 재시도          │
│  • 2차 시도: 2초 후 재시도          │
│  • 3차 시도: 4초 후 재시도          │
│  • 실패 시: 사람에게 알림            │
└─────────────────────────────────────┘
```

**효과**:
- 일시적 문제 자동 해결 (네트워크 끊김 등)
- 시스템 안정성 향상
- 사람 개입 최소화

---

### 2. Structured Logger (구조화 로거)

**비유**: 블랙박스 기록계

```
┌─────────────────────────────────────┐
│     Structured Logger               │
│                                     │
│  모든 이벤트를 JSON으로 기록         │
│  • 누가 (agent_name)                │
│  • 언제 (timestamp)                 │
│  • 무엇을 (event_type)              │
│  • 얼마나 (duration_ms)             │
│  • 추적번호 (trace_id)              │
└─────────────────────────────────────┘
```

**로그 예시**:
```json
{
  "timestamp": "2025-10-13T14:30:25Z",
  "trace_id": "abc12345",
  "event_type": "agent_start",
  "agent_name": "research-agent",
  "message": "연구 시작",
  "duration_ms": 1234.56
}
```

**활용**:
- 문제 발생 시 원인 추적
- 성능 병목 지점 파악
- 감사(audit) 로그

---

### 3. Performance Monitor (성능 모니터)

**비유**: 스포츠 통계 기록원

```
┌─────────────────────────────────────┐
│     Performance Monitor             │
│                                     │
│  각 에이전트의 성능 추적              │
│  • 실행 횟수                        │
│  • 성공률 (%)                       │
│  • 평균 소요 시간                    │
│  • 중앙값 (median)                  │
│  • 95번째 백분위수 (p95)            │
└─────────────────────────────────────┘
```

**출력 예시**:
```
======================================
Performance Summary
======================================
Agent           Exec  Success  Avg(ms)
--------------------------------------
research-agent    10   100.0%    1234
knowledge-b.       5    80.0%    2345
quality-agent      3   100.0%     567
======================================
```

**의사결정 지원**:
- 느린 에이전트 식별
- 신뢰도 낮은 에이전트 개선
- 용량 계획 수립

---

### 4. Context Manager (컨텍스트 관리자)

**비유**: 도서관 사서

```
┌─────────────────────────────────────┐
│     Context Manager                 │
│                                     │
│  정보를 카테고리별로 정리            │
│  • 세션 상태                        │
│  • 에러 로그                        │
│  • 의사결정 기록                    │
│  • 성능 메트릭                      │
│                                     │
│  자동 정리 (오래된 항목 삭제)        │
└─────────────────────────────────────┘
```

**카테고리 예시**:
- `session-state`: 현재 진행 상황 (보관 7일)
- `errors`: 에러 기록 (보관 30일)
- `decisions`: 중요 결정 (영구 보관)
- `milestone`: 주요 성과 (영구 보관)

**자동 정리 규칙**:
```
매 10회 저장마다 확인
  ↓
오래된 항목 있나?
  ↓
YES → 삭제
  ↓
저장 공간 확보
```

---

## 🎨 시스템 상태 시각화

### 정상 운영 상태

```
┌─────────────────────────────────────┐
│  System Status: 🟢 HEALTHY           │
├─────────────────────────────────────┤
│  Meta-Orchestrator:     ✅ Active   │
│  Research Agent:        ✅ Active   │
│  Knowledge Builder:     ✅ Active   │
│  Quality Agent:         ✅ Active   │
│  Example Generator:     ✅ Active   │
│  Dependency Mapper:     ✅ Active   │
│  Socratic Planner:      ✅ Active   │
├─────────────────────────────────────┤
│  Infrastructure:                    │
│    Error Handler:       ✅ Ready    │
│    Logger:              ✅ Running  │
│    Performance Monitor: ✅ Running  │
│    Context Manager:     ✅ Running  │
└─────────────────────────────────────┘
```

---

### 경고 상태

```
┌─────────────────────────────────────┐
│  System Status: 🟡 WARNING           │
├─────────────────────────────────────┤
│  Research Agent:        ⚠️ Slow     │
│    Average: 3.5초 (기준: 2.0초)     │
│                                     │
│  Knowledge Builder:     ⚠️ Retrying │
│    Retry 2/3                        │
└─────────────────────────────────────┘

권장 조치:
1. 성능 로그 확인
2. 네트워크 상태 점검
3. 리소스 사용량 확인
```

---

### 에러 상태

```
┌─────────────────────────────────────┐
│  System Status: 🔴 ERROR             │
├─────────────────────────────────────┤
│  Research Agent:        ❌ Failed   │
│    3회 재시도 모두 실패              │
│                                     │
│  ⚠️ HUMAN INTERVENTION REQUIRED     │
│                                     │
│  trace_id: abc12345                 │
│  error_type: TimeoutError           │
│  timestamp: 2025-10-13 14:30:00     │
└─────────────────────────────────────┘

수동 조치 필요:
1. 에러 로그 확인
2. MCP 서버 연결 상태 확인
3. API 키 유효성 확인
4. 시스템 재시작 고려
```

---

## 📈 성능 개선 효과

### Before (v1.0)

```
사용자 요청
  ↓
research (60초)
  ↓
knowledge (60초)
  ↓
quality (60초)
  ↓
example (60초)
  ↓
dependency (60초)
  ↓
총 소요 시간: 5분
```

### After (v2.0)

```
사용자 요청
  ↓
┌────────┬────────┬────────┬────────┐
│research│knowl   │quality │example │ (병렬 실행)
│(60초)  │(60초)  │(60초)  │(60초)  │
└────────┴────────┴────────┴────────┘
  ↓
총 소요 시간: 1분 + α

⚡ 80% 시간 단축
```

**추가 혜택**:
- 🔄 에러 자동 복구
- 📊 실시간 성능 모니터링
- 🔍 완전한 추적 가능성
- 💾 자동 컨텍스트 저장

---

## 🔧 유지보수 가이드 (비기술자용)

### 로그 파일 위치

```
/tmp/math-agent-logs/
└── agent-20251013.jsonl  ← 오늘 로그
```

**로그 확인 방법**:
```bash
# 최근 로그 보기
tail -f /tmp/math-agent-logs/agent-20251013.jsonl

# 특정 에이전트 로그만 보기
grep "research-agent" agent-20251013.jsonl

# 에러만 보기
grep "ERROR" agent-20251013.jsonl
```

---

### 성능 리포트 보는 방법

프로그램 종료 시 자동으로 표시됩니다:

```
==================================================
Performance Monitoring Summary
==================================================
Session duration: 120s

Agent                     Exec   Success    Avg(ms)
--------------------------------------------------
meta-orchestrator         10     100.0%      1234
research-agent            5      100.0%      2345
knowledge-builder         3       66.7%      1567  ← 성공률 낮음!
quality-agent             2      100.0%       890
==================================================
```

**해석**:
- `Exec`: 실행 횟수
- `Success`: 성공률 (%)
- `Avg(ms)`: 평균 소요 시간 (밀리초)

**주의 사항**:
- 성공률 <80%: 해당 에이전트 점검 필요
- 평균 시간 >3000ms (3초): 성능 개선 필요

---

### 에러 알림 받았을 때

```
⚠️ HUMAN INTERVENTION REQUIRED
================================
Agent: research-agent
Task: abc12345
Failed attempts: 3

Error history:
  1. [14:30:00] TimeoutError: Connection timeout
  2. [14:30:02] TimeoutError: Connection timeout
  3. [14:30:06] TimeoutError: Connection timeout

Action Required:
1. MCP 서버 상태 확인
2. 네트워크 연결 확인
3. API 키 유효성 확인
================================
```

**조치 순서**:
1. 로그 파일에서 `trace_id` 찾기
2. 해당 trace_id의 모든 이벤트 확인
3. 에러 타입 분석
4. 근본 원인 해결
5. 시스템 재시작

---

## 📞 문의 및 지원

### 일반 문의
- **시스템 위치**: `/home/kc-palantir/math`
- **문서 위치**: `.claude/memories/phase-progress/`

### 기술 지원
- **테스트 실행**: `uv run python test_infrastructure.py`
- **로그 분석**: 개발자에게 trace_id 제공

---

## 🎓 용어 사전

| 용어 | 설명 | 비유 |
|------|------|------|
| trace_id | 요청 추적 고유 번호 | 택배 송장 번호 |
| agent | 특정 작업 수행 AI | 전문가 직원 |
| orchestrator | 에이전트 조율자 | 오케스트라 지휘자 |
| retry | 실패 시 재시도 | 다시 시도하기 |
| backoff | 재시도 간격 증가 | 점점 길게 기다리기 |
| JSONL | 한 줄에 하나씩 JSON | 엑셀의 한 행 |
| p95 | 95번째 백분위수 | 상위 5% 제외한 최댓값 |
| context | 상황 정보 | 대화 맥락 |
| escalation | 상위 단계 보고 | 관리자에게 에스컬레이션 |

---

## ✅ 체크리스트 (시스템 관리자용)

### 일일 점검
- [ ] 로그 파일 크기 확인 (>100MB 시 정리)
- [ ] 성능 리포트 확인 (평균 시간 증가 추세?)
- [ ] 에러 발생 건수 확인 (>10회/일 시 조사)

### 주간 점검
- [ ] 성공률 통계 확인 (전체 평균 >90%?)
- [ ] 디스크 사용량 확인 (`/tmp` 정리)
- [ ] MCP 서버 연결 상태 확인

### 월간 점검
- [ ] 전체 시스템 성능 리뷰
- [ ] 에이전트별 개선 우선순위 선정
- [ ] 백업 데이터 아카이빙

---

**문서 끝**

*본 문서는 Claude Sonnet 4.5가 2025년 10월 13일 자동 생성했습니다.*
*비프로그래머도 시스템 전체 구조를 이해할 수 있도록 작성되었습니다.*
